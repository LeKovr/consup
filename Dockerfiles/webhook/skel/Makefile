# Consup application Makefile
SHELL    = /bin/bash
PRG     ?= $(shell basename $$PWD)
CFG     ?= .config

SSH_KEY_NAME ?= hook

# Полный путь к текущему каталогу
APP_ROOT ?= $(shell dirname $$PWD)
# Имя текущего каталога
APP_PATH ?= $(shell basename $$PWD)

CONSUP_ROOT ?= ../..

# имя сайта для контейнера (см .config)
APP_NAME   ?= ci
APP_DOMAIN ?= .dev.lan
APP_SITE   ?= $(APP_NAME)$(APP_DOMAIN)

# префикс контейнеров
PROJECT ?= consup

# Файл .config
define CONFIG_DEF
# project config file, generated by make $(CFG)
APP_SITE=$(APP_SITE)
PROJECT=$(PROJECT)
endef
export CONFIG_DEF


all: start

## настройка контейнера из CI хука
setup: $(CFG)

## старт контейнера из CI хука
start-hook: startonly

start: ssh-key stop startonly

## стартовать контейнер, ничего не удаляя
startonly: $(CFG)
	@echo "*** $@ ***"
	@source $(CFG) && \
  CONSUP_ROOT=$(CONSUP_ROOT) \
  fidm start project=$$PROJECT name=$$APP_SITE \
    args_add=--volume=$(APP_ROOT)/$(APP_PATH):/home/app \
    args_add=--volume=$(APP_ROOT)/../log/http/$(APP_PATH):/var/log/nginx \
    args_add=--volume=$(APP_ROOT)/../log/$(APP_PATH):/var/log/supervisor

## остановить и удалить контейнер
stop: $(CFG)
	@echo "*** $@ ***"
	@source $(CFG) && \
  CONSUP_ROOT=$(CONSUP_ROOT) \
  fidm rm project=$$PROJECT name=$$APP_SITE

## остановить и удалить контейнер и все контейнеры, от которых он зависит
stopall: $(CFG)
	@echo "*** $@ ***"
	@source $(CFG) && \
  CONSUP_ROOT=$(CONSUP_ROOT) \
  fidm rm -a project=$$PROJECT name=$$APP_SITE

clean:
	@echo "*** $@ ***"
	[ ! -f $(CFG) ] || rm $(CFG)

ssh-key: $(SSH_KEY_NAME).pub

$(SSH_KEY_NAME).pub:
	ssh-keygen -t rsa -b 4096 -f $(SSH_KEY_NAME) -N "" -C webhook

$(CFG):
	@echo "*** $@ ***"
	@[ -f $@ ] || echo "$$CONFIG_DEF" > $@

## dump KV storage
dump-kv:
	@curl -s http://localhost:8500/v1/kv/conf?recurse \
  | jq -r '.[] | .Key +" "+  .Value ' | while read k v ; \
  do val=$$(echo -n "$$v" | base64 -d) ; echo "$$k=$$val" ; done

deps:
	@echo "*** $@ ***"
	# code from http://docs.docker.com/linux/step_one/
	which docker > /dev/null || wget -qO- https://get.docker.com/ | sh
	# code from https://github.com/LeKovr/fidm
	which fidm > /dev/null || wget -qO- https://raw.githubusercontent.com/LeKovr/fidm/master/install.sh | sh
	# Каталог **consup** дожен быть доступен из каталога **iac** как `../consup` или `../../consup`.
	cd .. &&[ -d consup ] || [ -d ../consup ] || git clone https://github.com/LeKovr/consup.git
	# контейнеры Docker
	for n in consul nginx webhook ; do docker pull lekovr/consup_$$n ; done
	@echo Done

# запуск bash в контейнере
bash: startonly
	@echo "*** $@ ***"
	source $(CFG) && \
docker exec -ti "consup_$${APP_SITE}_main" bash

.PHONY: all push remote build restore deps
