
# Сервер непрерывной интеграции

Проект предназначен для автоматической сборки и развертывания приложения при изменении его исходного кода.

## Описание

### Ключевые компоненты интеграции

* [Git-сервис](../../gogs/skel/README.ru.md), поддерживающий webhook 
* [Key-value хранилище конфигураций и [интерфейс к нему](../../consul/skel/README.ru.md)
* Сервис webhook, выполняющий код при поступлении запроса от Git-сервиса
* Сервис доступа к логам

### Алгоритм интеграции

* Git-сервис при получении обновления отправляет запрос сервису webhook
* сервис webhook 
** клонирует указанную в запросе версию кода из репозитория (заданную ветку или тег)
** при первом запуске выполняет `make setup` и сохраняет ключи из файла `.config` в KV-store и завершает работу
* т.к. все нужные ключи уже помещены в KV-store, их можно отредактировать через веб-интерфейс (в т.ч. активировать интеграцию)
* При повторном запуске, если интеграция активна, сервис webhook
** сохраняет настройки из KV-store в файл .config
** выполняет `make start-hook`


Алгоритм заключается в подключении в gogs хука, который реагирует на присвоение тега в проекте.
В настройках задается **СУФФИКС** и после пуша с тегом **ТЭГ** производится настройка сервера **http://ТЭГ.СУФФИКС**

**ВАЖНО**: для использования данного документа необходимо наличие ssh-доступа к хосту, на котором разворачивается сервер.

Для автоматического деплоя необходимо произвести настройку проекта

## Настройка

### Клиент ssh

В файле `~/.ssh/config`[^1] добавить
```
Host it
  user op
  port 72
  LocalForward 5438 localhost:5432
  hostname your_host_name

  # Postgresql
  LocalForward 5438 localhost:5432

  # Consul UI
  LocalForward 8141 127.0.1.2:8500

  # WebTail
  LocalForward 8131 127.0.1.2:8600

```

Ниже в документации используются адреса http://127.0.0.1. Для того, чтобы они были доступны, необходимо предварительно выполнить команду `ssh it`.


### Gogs, раздел "Настройки / Автоматическое обновление"

* Создать хук типа Gogs
* URL: http://ci.it.tender.pro.web.service.consul/hooks/consuphook
* Тип содержимого: application/json
* На какие события этот webhook должен срабатывать? "Позвольте мне выбрать то, что нужно" и там выбрать "Push" (для автодеплоя при пуше) и/или "Создать" (для автодеплоя при пуше нового тега)

**ВНИМАНИЕ** деплой не будет отрабатывать при создании ветки (т.е. не тега). Сообщение в логе будет таким - "Hook skipped - no event"

### Gogs, раздел "Настройки / Ключи развертывания"

Добавить [публичный ключ](https://ci.it.tender.pro/hook.pub) (в конце ключа не должно быть перевода строки).

Нажать кнопку "Проверить доставку" и проверить, что в последней строке ответа есть фраза "Prepared default config. Exiting"

### Настройка деплоя

* Открыть [KV-store CI-сервера](http://127.0.0.1:8141/ui/#/consup/kv/conf/)
* найти там раздел настроек приложения (имя вида `владелец--репозиторий--ветка--default`)
* заменить дефолтные значения на нужные
* для активации деплоя найти (или создать) ключ `_CI_HOOK_ENABLED` и установить ему значение `yes`
* после этого кнопка "Проверить доставку" или `git push` будет приводить к деплою проекта

**ВАЖНО**: Если сервис будет доступен по http, имя хоста задается в `APP_SITE` и по этому имени получается сертификат Let's Encrypt.
Некорректное имя хоста может привести к остановке всех http-сервисов компьютера.

По умолчанию деплой завершается командой `make start-hook`. Цель `start-hook` можно изменить, отредактировав значение параметра `_CI_MAKE_START`.

Имя раздела настроек приложения можно изменить, задав в URL хука параметр ?config=XXX или ?config=/XXX. При этом

* если значение начинается с `/` - имя раздела будет заменено полностью
* иначе - значение заменит суффикс `default`

## Настройка приложения

Дистрибутив приложения должен содержать файл Makefile ([пример](https://github.com/LeKovr/consup/blob/master/Dockerfiles/mattermost/skel/Makefile)),
цели которого будут вызываться при деплое:

* `make setup` - после `git clone`, должен создавать файл .config который будет загружен в KV-store
* `make stop` - перед удалением каталога приложения
* `APP_ROOT=/distro APP_PATH=appname make start-hook` - запуск приложения в каталоге /distro/appname

**Внимание**: Выше - команды, которые выполняет скрипт автодеплоя. Разработчик их руками не выполняет, а только готовит Makefile.
Разработчик делает только `git commit` и `git push`. Автодеплой начинается автоматически после выполнения push.
Результат его работы сохраняется в журнале контейнера ([пример ссылки](http://127.0.0.1:8131/#ci.it.tender.pro_main/webhook-stderr---supervisor-2t9P_R.log)).

## Использование

Пример для **ТЭГ**=pre
```
# удалить старый тег в репозитории
git push origin :refs/tags/pre

# обновить тег локально
git tag -f pre
# опубликовать тег
git push --tags
```

Пример для ветки rmXX
```
# перейти на ветку
git checkout rmXX

# обновить ветку
git merge origin/master

# запушить изменения
git push
```

При первом запуске в Consul KV-store будет создан раздел вида `/conf/владелец--имя_репо--ветка--default` и туда перенесены ключи из .config.
После того надо изменить значение ключа `_CI_HOOK_ENABLED` на `yes` и настроить остальные параметры.


## Деплой без рестарта контейнера

Стандартный порядок операций деплоя:

1. остановить контейнер
2. выгрузить код из git
3. выполнить make start-hook

Такой деплой приводит к даунтайму сервиса на время выполнения шагов 2 и 3.

Кроме стандартного, CI сервер поддерживает упрощенный порядок деплоя, который выполняется без рестарта контейнера:

1. выполнить `git pull` (вывод пишется в лог CI-сервера)
2. выполнить `make update` (вывод пишется в update.log каталога логов контейнера)

Настройка такого обновления производится двумя параметрами в KV-store:

* `_CI_HOOK_UPDATE_HOT` - если его значение `yes`, активный деплой отработает по упрощенному порядку
* `_CI_MAKE_UPDATE` - цель make, которая будет выполнена после `git pull`

## Деплой без коммита

Производится с помощью Gogs, раздел "Настройки / Ключи развертывания"

* Для ветки **master**
  * нажать кнопку "Проверить доставку"
* Для других веток/тегов
  * в поле "URL обработчика" добавить аргумент `?tag=XXX`, где XXX - имя тега или ветки
  * нажать кнопку "Обновление Webhook"
  * нажать кнопку "Проверить доставку"
  * удалить аргумент `?tag` после использования (иначе push на master задеплоит ветку XXX)


## Отмена деплоя

Если хук настроен на событие "create", то при создании тега с именем XXX-rm, будет произведена отмена деплоя с именем XXX:

* если в каталоге есть Makefile - будет выполнен `make stop`
* если есть каталог - он будет удален

## Дополнительные сервисы

### Доступ к журналам контейнера

Журналы контейнеров доступны по адресу http://127.0.0.1:8131/.

Веб-интерфейс к журналам реализован с помощью [WebTail](https://github.com/LeKovr/webtail).
В лог выводятся последние 200 строк и потом происходит заполнение в реалтайме (через websockets).

### Как посмотреть журнал полностью

Зайти по ssh в каталог /opt/srv/ci/log - там все, что выводит WebTail.

### Интерфейс настроек.

Реализован consul-ui. После запуска consul-ui будет доступен по адресу http://127.0.1.2:8500.

Удаленный доступ к интерфейсу производится через ssh-туннель (т.е. необходим доступ к серверу по ssh)

### Клиент ssh

На стороне клиента настройка туннеля производится в файле .ssh/config в домашнем каталоге пользователя.
В блоке настроек сервера добавляются строки:

```
# Host your.consup.srv

  # Consul UI
  LocalForward 8141 127.0.1.2:8500

```


## Примечания

[^1]: символом `~` в linux обозначается домашний каталог пользователя, в него можно попасть командой `cd`.
