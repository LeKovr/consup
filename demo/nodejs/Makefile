# iac.tender.pro backend Makefile
SHELL    = /bin/bash
PRG     ?= $(shell basename $$PWD)
CFG     ?= .config

APP_ROOT ?= $$PWD
APP_SITE ?= test.dev.lan
API_SITE ?= iac.it.tender.pro

define CONFIG_DEF
# project config file, generated by make $(CFG)
APP_SITE=$(APP_SITE)
API_SITE=$(API_SITE)
endef
export CONFIG_DEF

all: start

setup: vars onstart

start: setup
	@echo "*** $@ ***"
	@source $(CFG) && \
fidm rm mode=www name=$$APP_SITE ; \
fidm start mode=www name=$$APP_SITE \
  args_add=--volume=$(APP_ROOT):/home/app \
  args_add=--volume=$(APP_ROOT)/../../log/$$APP_SITE:/var/log/supervisor

stop: $(CFG)
	@echo "*** $@ ***"
	@source $(CFG) && \
fidm rm mode=www name=$$APP_SITE

stopall: $(CFG)
	@echo "*** $@ ***"
	@source $(CFG) && \
fidm rm -a mode=www name=$$APP_SITE

vars: $(CFG) ~/.fidmrc html/hostvar.js

$(CFG):
	@echo "*** $@ ***"
	@[ -f $@ ] || echo "$$CONFIG_DEF" > $@

# настройка контейнеров consup
~/.fidmrc:
	@echo "*** $@ ***"
	@echo "cfg[creator]=lekovr" > $@

html/hostvar.js:
	@echo "*** $@ ***"
	@source $(CFG) && echo "var iacHost = 'http://$$API_SITE';" > $@

onstart: html/facetvar.js

html/facetvar.js:
	@echo "*** $@ ***"
	source $(CFG) && \
JSON=$$(curl http://$$API_SITE/api/ru_ref_facet) && \
echo "var facetData = $$JSON;" > $@

# ------------------------------------------------------------------------------
# NPM

# Development deps
dev-deps:
	FIDM_CMD="/init.sh npm install gulp bower gulp-jshint gulp-uglify gulp-connect \
  gulp-watch gulp-autoprefixer gulp-less gulp-sourcemaps gulp-rigger gulp-imagemin \
  gulp-cssnano del imagemin-pngquant browser-sync \
  --save" fidm start nodejs.yml

# App deps
deps:
	FIDM_CMD="/init.sh bower install \
  angular angular-animate angular-route jquery animate.css bootstrap fontawesome normalize.css \
  --save --config.analytics=false" fidm start nodejs.yml


npm: npm-install

# Use: ARGS="gulp --save-dev" make npm-install
npm-%:
	X=$@ ; FIDM_CMD="npm $${X#npm-} $$ARGS" fidm start nodejs.yml

# Use: make bower-list
# Use: PKG=jquery make bower-search
bower-%:
	X=$@ ; FIDM_CMD="/init.sh bower $${X#bower-} $$PKG --config.analytics=false" fidm start nodejs.yml

# Use: PKG=angularjs make bower-install
bower-install:
	FIDM_CMD="/init.sh bower install --save $$PKG --config.analytics=false" fidm start nodejs.yml

# Use: PKG=gulp-watch make bower-installdev
bower-installdev:
	FIDM_CMD="/init.sh bower install --savedev $$PKG --config.analytics=false" fidm start nodejs.yml

# Use: make gulp-build:html
gulp-%:
	X=$@ ; FIDM_CMD="/init.sh gulp $${X#gulp-}" fidm start nodejs.yml

# Use: CMD=mc make cmd
cmd:
	FIDM_CMD="/init.sh $$CMD" fidm start nodejs.yml

.PHONY: all start stop stopall

