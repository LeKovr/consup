# iac.tender.pro backend Makefile
SHELL    = /bin/bash
PRG     ?= $(shell basename $$PWD)
CFG     ?= .config

# этот параметр передает хук
APP_ARG  ?= api.dev.lan
PROJECT  ?= book

APP_ROOT ?= $$PWD
# имя сайта для контейнера
APP_SITE ?= test.dev.lan

# имя ветки
APP_TAG ?= master

CONSUP_ROOT ?= ..
SHARED_ROOT  ?= $(APP_ROOT)

define CONFIG_DEF
# project config file, generated by make $(CFG)
APP_SITE=$(APP_SITE)
endef
export CONFIG_DEF

all: start

## настройка контейнера из CI хука
setup: $(CFG)

dirs:
	@[ -d html ] || ln -s _book html
	@[ -d log ] || mkdir log

# поднять общие каталоги на уровень выше
start-hook: SHARED_ROOT = $(APP_ROOT)/..

## старт контейнера из CI хука
start-hook: start

## стартовать контейнер, предварительно удалив старый, если был
start: stop startonly

## стартовать контейнер, ничего не удаляя
startonly: $(CFG) build
	@echo "*** $@ ***"
	@source $(CFG) && \
fidm start mode=www name=$$APP_SITE \
  args_add=--volume=$(APP_ROOT):/home/app \
  args_add=--volume=$(SHARED_ROOT)/../log/$$APP_SITE:/var/log/supervisor

## остановить и удалить контейнер
stop: $(CFG)
	@echo "*** $@ ***"
	@source $(CFG) && \
fidm rm mode=www name=$$APP_SITE

## остановить и удалить контейнер и все контейнеры, от которых он зависит
stopall: $(CFG)
	@echo "*** $@ ***"
	@source $(CFG) && \
fidm rm -a mode=www name=$$APP_SITE

$(CFG):
	@echo "*** $@ ***"
	@[ -f $@ ] || echo "$$CONFIG_DEF" > $@


# ------------------------------------------------------------------------------
# Docker

## установка зависимостей
deps:
	@echo "*** $@ ***"
	@echo "Consup root: $(CONSUP_ROOT)"
	# code from http://docs.docker.com/linux/step_one/
	which docker > /dev/null || wget -qO- https://get.docker.com/ | sh
	# code from https://github.com/LeKovr/fidm
	which fidm > /dev/null || wget -qO- https://raw.githubusercontent.com/LeKovr/fidm/master/install.sh | sh
	# Каталог **consup** должен быть доступен из каталога **iac** как `../consup` или `../../consup`.
	[[ -d $(CONSUP_ROOT)/consup ]] || cd $(CONSUP_ROOT) && wget -qO- https://raw.githubusercontent.com/LeKovr/consup/master/install.sh | sh
	# контейнеры Docker
	for n in consul nginx nodejs ; do docker pull lekovr/consup_$$n ; done
	@echo Done


# ------------------------------------------------------------------------------
# Gitbook

book-init: BOOK_CMD = init
book-init: book-cmd

book-serve: BOOK_CMD = serve
book-serve: book-cmd

book-build: BOOK_CMD = build ./
book-build: book-cmd

book-pdf: BOOK_CMD = pdf ./ _book/$(PROJECT).pdf
book-pdf: book-cmd

book-epub: BOOK_CMD = epub ./ ./_book/$(PROJECT).epub
book-epub: book-cmd

book-cmd:
	@source $(CFG) && \
  FIDM_CMD="gitbook $(BOOK_CMD)" \
  fidm start nodejs.yml \
    args_add=--volume=$(APP_ROOT):/home/app

#	@[ -L html ] && rm html ; \

book-all:
	@source $(CFG) && \
  FIDM_CMD="bash ./buildall.sh $(PROJECT)" \
  fidm start nodejs.yml \
    args_add=--volume=$(APP_ROOT):/home/app

build: book-all dirs

.PHONY: all start stop stopall build serve book-cmd book-build

